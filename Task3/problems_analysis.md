# Анализ текущей архитектуры InsureTech

## Выявленные проблемы и риски

### 1. Проблемы синхронного взаимодействия

**Проблема**: ins-product-aggregator выполняет синхронные запросы ко всем страховым компаниям и ждет ответов от всех участников перед возвратом результата.

**Риски при росте до 10 компаний**:
- Время отклика увеличится пропорционально самому медленному участнику
- Вероятность отказа системы возрастет с 5% до 10% (при доступности каждой компании 99%)
- Каскадные отказы при недоступности одной из компаний

### 2. Неэффективность периодических запросов

**Проблема**: core-app запрашивает данные каждые 15 минут, ins-comp-settlement - раз в сутки, независимо от наличия изменений.

**Риски при росте до 10 компаний**:
- Увеличение нагрузки на ins-product-aggregator в 2 раза
- Пиковые нагрузки в фиксированное время
- Неактуальные данные между периодами опроса

### 3. Устаревание данных

**Проблема**: Между запросами данные о продуктах и тарифах могут изменяться, но сервисы получают обновления только по расписанию.

**Риски при росте до 10 компаний**:
- Чем больше компаний, тем чаще происходят изменения тарифов
- Увеличивается вероятность работы с устаревшими данными
- Потенциальные финансовые потери из-за неактуальных тарифов

### 4. Тесная связанность сервисов

**Проблема**: Прямые REST зависимости между сервисами создают жесткую связанность архитектуры.

**Риски при росте до 10 компаний**:
- Сложность внесения изменений в API
- Необходимость координации релизов между командами
- Увеличение времени разработки новых интеграций

### 5. Обработка больших объемов данных

**Проблема**: ins-comp-settlement загружает все оформленные за день страховки одним запросом.

**Риски при росте до 10 компаний**:
- Размер передаваемых данных увеличится в 2-3 раза
- Риск превышения таймаутов и лимитов памяти
- Сложность восстановления при сбоях в процессе передачи

### 6. Отсутствие механизмов отказоустойчивости

**Проблема**: Нет автоматических механизмов повторных попыток и обработки частичных отказов.

**Риски при росте до 10 компаний**:
- Увеличение количества точек отказа
- Сложность диагностики проблем в цепочке взаимодействий
- Снижение общей доступности системы

## Предлагаемые решения

### Переход на Event-Driven архитектуру

1. **Замена синхронных запросов на события**
   - ins-product-aggregator публикует события об изменении продуктов
   - core-app и ins-comp-settlement подписываются на эти события
   - Устранение периодических запросов

2. **Использование Transactional Outbox паттерна**
   - Гарантия доставки событий через запись в outbox таблицу
   - Использование CDC (Change Data Capture) для надежной публикации событий
   - Обеспечение согласованности данных

3. **Асинхронная обработка данных о полисах**
   - core-app публикует события о создании/изменении полисов
   - ins-comp-settlement обрабатывает события по мере поступления
   - Устранение больших batch-операций

### Преимущества предлагаемого решения

- Снижение латентности до времени самого быстрого участника
- Актуальность данных в реальном времени
- Изоляция отказов отдельных компаний
- Линейное масштабирование при добавлении новых участников
- Слабая связанность между сервисами
- Улучшенная наблюдаемость и мониторинг 